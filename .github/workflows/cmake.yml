name: CMake

on:
  push: # pull_request:
    branches: [ "main" ] 

jobs:
  build:
    runs-on: ubu20GPU # ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Build
      run:  | 
            mkdir ${{github.workspace}}/build
            cd ${{github.workspace}}/build
            cmake -DCMAKE_INSTALL_PREFIX=/tmp/carlsim6 \
                  -DCMAKE_BUILD_TYPE=Release .. \
                  -DCARLSIM_PYCARL=OFF \
                  -DCARLSIM_NO_CUDA=OFF \
                  -DCARLSIM_STATIC=OFF \
                  -DCARLSIM_SHARED=ON \
                  -DCARLSIM_TEST=ON
            make -j$(nproc) install
            
    - name: Run tests
      run:  | 
            cd ${{github.workspace}}/build
            ./carlsim/test/carlsim-tests
            ./carlsim/test6/carlsim-tests6
            lcov --directory ./ --capture --output-file ./code_coverage.lcov -rc lcov_branch_coverage=1
            # weird error where a single /tmp file in 250k lines of code is generated.
            # just going to filter manually for now, unless it becomes a bigger issue
            # https://github.com/bainro/autoCARL/actions/runs/5065893843/jobs/9095003642#step:4:422
            sed -e '/tmp/d' ./code_coverage.lcov > /tmp/_tmp.lcov
            mv /tmp/_tmp.lcov ./code_coverage.lcov
            # for generating html to be viewed locally
            # genhtml code_coverage.lcov --branch-coverage --output-directory ./code_coverage_report/
            
    - name: Coveralls
      uses: coverallsapp/github-action@master
      with: 
            github-token: ${{ secrets.GITHUB_TOKEN }}
            path-to-lcov: ${{github.workspace}}/build/code_coverage.lcov
